<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module      : STLink.Driver
Description : Low-level USB driver for STLink dongles
Copyright   : (c) UBC Orbit
Maintainer  : sam.schwiegel@ubcorbit.com

Most users shouldn't have to import this module, since the important
bits are re-exported elsewhere.
-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">STLink</span><span class="hs-operator">.</span><span class="hs-identifier">Driver</span><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="STLink.Driver.html#inCommand"><span class="hs-identifier hs-var">inCommand</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="STLink.Driver.html#outCommand"><span class="hs-identifier hs-var">outCommand</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="STLink.Driver.html#withAutoBoard"><span class="hs-identifier hs-var">withAutoBoard</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="STLink.Driver.html#withBoard"><span class="hs-identifier hs-var">withBoard</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span class="hs-special">(</span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="STLink.Detection.html"><span class="hs-identifier">STLink</span><span class="hs-operator">.</span><span class="hs-identifier">Detection</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">USB</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-comment">-- | Utility function that throws an error 'e' in the 'ExceptT' monad</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- if the condition is met.</span><span>
</span><a name="line-28"></a><span class="hs-identifier">eguard</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679047319"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679047320"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><a href="#local-6989586621679047320"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679047319"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><a name="eguard"><a href="STLink.Driver.html#eguard"><span class="hs-identifier">eguard</span></a></a><span> </span><a name="local-6989586621679047321"><a href="#local-6989586621679047321"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><a href="#local-6989586621679047321"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-30"></a><span class="hs-identifier">eguard</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-comment">-- | Low-level command that formats an &quot;inward&quot; command the way the</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- STLink dongle likes it:</span><span>
</span><a name="line-34"></a><span class="hs-comment">--</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- USB_BULK out \&lt;up to 16 bytes of commands\&gt;</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- USB_BULK in \&lt;expected response length\&gt;</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-39"></a><span class="hs-comment">--</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- Since USB is a host-oriented protocol, we have to know in advance</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- how many bytes to read from the device's buffer.</span><span>
</span><a name="line-42"></a><span class="hs-identifier">inCommand</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DeviceHandle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Size</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-44"></a><a name="inCommand"><a href="STLink.Driver.html#inCommand"><span class="hs-identifier">inCommand</span></a></a><span> </span><a name="local-6989586621679047467"><a href="#local-6989586621679047467"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679047468"><a href="#local-6989586621679047468"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679047469"><a href="#local-6989586621679047469"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679047470"><a href="#local-6989586621679047470"><span class="hs-identifier">size</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679047471"><a href="#local-6989586621679047471"><span class="hs-identifier">sendStatus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeBulk</span><span> </span><a href="#local-6989586621679047467"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EndpointAddress</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier hs-var">Out</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047468"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-46"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;sent command truncated&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047470"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679047468"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-47"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;send timed out&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047471"><span class="hs-identifier hs-var">sendStatus</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Completed</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-comment">-- receive the response, and ensure it's what we expected</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679047472"><a href="#local-6989586621679047472"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679047473"><a href="#local-6989586621679047473"><span class="hs-identifier">recStatus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readBulk</span><span> </span><a href="#local-6989586621679047467"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EndpointAddress</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier hs-var">In</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047469"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-50"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;response truncated&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047469"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679047472"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-51"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;receive timed out&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047473"><span class="hs-identifier hs-var">recStatus</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Completed</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679047472"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-comment">-- send the command and make sure it was sucessful</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- | Low-level command that formats an &quot;outward&quot; command the way the</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- STLink dongle likes it:</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- USB_BULK out \&lt;up to 16 bytes of commands\&gt;</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- USB_BULK out \&lt;outward-bound data\&gt;</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-62"></a><span class="hs-identifier">outCommand</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DeviceHandle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><a name="outCommand"><a href="STLink.Driver.html#outCommand"><span class="hs-identifier">outCommand</span></a></a><span> </span><a name="local-6989586621679047474"><a href="#local-6989586621679047474"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679047475"><a href="#local-6989586621679047475"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679047476"><a href="#local-6989586621679047476"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679047477"><a href="#local-6989586621679047477"><span class="hs-identifier">sendSize</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679047478"><a href="#local-6989586621679047478"><span class="hs-identifier">sendStatus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeBulk</span><span> </span><a href="#local-6989586621679047474"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EndpointAddress</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier hs-var">Out</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047475"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-66"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;sent command truncated&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047477"><span class="hs-identifier hs-var">sendSize</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679047475"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-67"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;send command timed out&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047478"><span class="hs-identifier hs-var">sendStatus</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Completed</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-comment">-- send the data</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679047479"><a href="#local-6989586621679047479"><span class="hs-identifier">recSize</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679047480"><a href="#local-6989586621679047480"><span class="hs-identifier">recStatus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeBulk</span><span> </span><a href="#local-6989586621679047474"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EndpointAddress</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier hs-var">Out</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047476"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-70"></a><span>  </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;sent data truncated&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047479"><span class="hs-identifier hs-var">recSize</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679047476"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="STLink.Driver.html#eguard"><span class="hs-identifier hs-var">eguard</span></a><span> </span><span class="hs-string">&quot;send data timed out&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047480"><span class="hs-identifier hs-var">recStatus</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Completed</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-comment">-- send the command and make sure it was sucessful</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- | This monad lets you write effectful computations that communicate</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- with an STLink dongle, without explicitly specifying the dongle you</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- want to talk with for every command.  Generally, 'runSTLink</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- wouldn't be used directly since it takes a low-level 'DeviceHandle'</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- instead of a general 'Device'.  See 'withBoard' for a safe,</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- high-level way to run an 'STLink'.</span><span>
</span><a name="line-80"></a><span class="hs-keyword">newtype</span><span> </span><a name="STLink"><a href="STLink.Driver.html#STLink"><span class="hs-identifier">STLink</span></a></a><span> </span><a name="local-6989586621679046756"><a href="#local-6989586621679046756"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="STLink"><a href="STLink.Driver.html#STLink"><span class="hs-identifier">STLink</span></a></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="runSTLink"><a href="STLink.Driver.html#runSTLink"><span class="hs-identifier">runSTLink</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DeviceHandle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679046756"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-85"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679047054"><a href="#local-6989586621679047054"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><a name="local-6989586621679047055"><a href="#local-6989586621679047055"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679047054"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679047055"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-88"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621679047050"><a href="#local-6989586621679047050"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679047050"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-special">(</span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><a name="local-6989586621679047051"><a href="#local-6989586621679047051"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span> </span><span class="hs-special">(</span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><a name="local-6989586621679047052"><a href="#local-6989586621679047052"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679047053"><a href="#local-6989586621679047053"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679047051"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679047053"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679047052"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679047053"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-92"></a><span>  </span><span class="hs-special">(</span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><a name="local-6989586621679047047"><a href="#local-6989586621679047047"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621679047048"><a href="#local-6989586621679047048"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679047049"><a href="#local-6989586621679047049"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679047047"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679047049"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047049"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">runSTLink</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679047048"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-95"></a><span>  </span><a name="local-8214565720323787252"><span class="hs-identifier">liftIO</span></a><span> </span><a name="local-6989586621679047046"><a href="#local-6989586621679047046"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-var">STLink</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><a href="#local-6989586621679047046"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- | Automatically finds a board (and prompts the user to select one</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- if several are attached) and then runs the 'STLink' action with</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- that board.</span><span>
</span><a name="line-100"></a><span class="hs-identifier">withAutoBoard</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><a href="#local-6989586621679047057"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679047057"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><a name="withAutoBoard"><a href="STLink.Driver.html#withAutoBoard"><span class="hs-identifier">withAutoBoard</span></a></a><span> </span><a name="local-6989586621679047481"><a href="#local-6989586621679047481"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="STLink.Detection.html#pickBoard"><span class="hs-identifier hs-var">pickBoard</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="STLink.Driver.html#withBoard"><span class="hs-identifier hs-var">withBoard</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679047481"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">-- | Lets the user manually specify a USB 'Device' to execute the</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- 'STLink' action on.</span><span>
</span><a name="line-105"></a><span class="hs-identifier">withBoard</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Device</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="STLink.Driver.html#STLink"><span class="hs-identifier hs-type">STLink</span></a><span> </span><a href="#local-6989586621679047056"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679047056"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><a name="withBoard"><a href="STLink.Driver.html#withBoard"><span class="hs-identifier">withBoard</span></a></a><span> </span><a name="local-6989586621679047505"><a href="#local-6989586621679047505"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679047506"><a href="#local-6989586621679047506"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withDeviceHandle</span><span> </span><a href="#local-6989586621679047505"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679047507"><a href="#local-6989586621679047507"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-identifier hs-var">withClaimedInterface</span><span> </span><a href="#local-6989586621679047507"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">runSTLink</span><span> </span><a href="#local-6989586621679047506"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679047507"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-110"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679047640"><a href="#local-6989586621679047640"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;stlink driver error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679047640"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-112"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-113"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679047641"><a href="#local-6989586621679047641"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679047641"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-114"></a></pre></body></html>